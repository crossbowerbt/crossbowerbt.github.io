<!DOCTYPE html>
<html>

  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Fun with HexInject and USB protocols</title>
    <link href="css/main.css" rel="stylesheet" type="text/css">
  </head>
  
  <body>
    <article id="main">
      <h1>Fun with HexInject and USB protocols</h1>
      <h2>02 Jun 2011</h2>
      <br>

      <p>Did you know that pcap (<a href="http://www.tcpdump.org/">http://www.tcpdump.org/</a>) libraries can capture raw USB traffic?</p>

      <p>I had noticed several times the presence of various USB interfaces in wireshark but so far I've never tried to play with them:</p>

      <p>
	<a href="images/wireshark_interfaces.png">
	  <img class="center border" title="various wireshark interfaces" alt="various wireshark interfaces" src="images/wireshark_interfaces.png" />
	</a>
      </p>
      
      <p>On your system should appear similar interfaces. If not you can refer to this guide: <a href="http://wiki.wireshark.org/CaptureSetup/USB">http://wiki.wireshark.org/CaptureSetup/USB</a>.</p>

      <p>
	In this short post I just want to talk about a simple experiment I did with <a href="http://hexinject.sourceforge.net/">hexinject</a> and <a href="http://www.gnu.org/software/gawk/manual/gawk.html">awk</a>: <strong>the recognition of mouse clicks</strong>.
      </p>
      
      <p>The first thing to do is to find the port connected to the mouse. I'm sure there are more elegant systems to do it, but I just looked in wireshark at the <strong>port receiving packets when the mouse moved</strong>. In my case this was USB port 3 (<strong>usbmon3</strong>).</p>
      
      <p>Then we can try to sniff on this port, performing various actions with the mouse, to see if we can understand at least part of the protocol used.</p>

      <p>Captured data in the case of a left mouse click:</p>
	  
      <pre>
80 3A DF 2A 01 88 FF FF 43 01 81 02 03 00 2D 00 8D 43 E7 4D 00 00 00 00 AA 38 00 00 00 00 00 00 <em>06 00 00 00 06 00 00 00</em> 00 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 04 02 00 00 00 00 00 00 <strong>01</strong> 00 00 00 00 00
80 3A DF 2A 01 88 FF FF 53 01 81 02 03 00 2D 3C 8D 43 E7 4D 00 00 00 00 BD 38 00 00 8D FF FF FF 06 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 04 02 00 00 00 00 00 00
      </pre>

      <p dir="ltr">Captured data in the case of a right mouse click:</p>
	
      <pre>
80 3A DF 2A 01 88 FF FF 43 01 81 02 03 00 2D 00 AB 43 E7 4D 00 00 00 00 A2 22 03 00 00 00 00 00 <em>06 00 00 00 06 00 00 00</em> 00 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 04 02 00 00 00 00 00 00 <strong>02</strong> 00 00 00 00 00
80 3A DF 2A 01 88 FF FF 53 01 81 02 03 00 2D 3C AB 43 E7 4D 00 00 00 00 B4 22 03 00 8D FF FF FF 06 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 04 02 00 00 00 00 00 00
      </pre>

      <p>The first dumped line is generated by the mouse, the second should be the system acknowledgment (I think). The hexadecimal <strong>byte in bold represent the button</strong> pressed. Bytes in <strong>italic allow us to understand the type of action</strong> performed (a button action and not a mouse movement).</p>
      
      <p>Using these informations it's very easy to write an awk script that can tell us the type of action performed:</p>
	
      <pre>
<span style="color:#999999;">#</span>
<span style="color:#999999;"># Analyze USB mouse protocol</span>
<span style="color:#999999;"># and print button actions</span>
<span style="color:#999999;">#</span>
<span style="color:#999999;"># use with:</span>
<span style="color:#999999;">#   source_program | awk --enable-switch -f mouse_click.awk</span>
<span style="color:#999999;"># or sometimes just:</span>
<span style="color:#999999;">#   source_program | gawk -f mouse_click.awk</span>
<span style="color:#999999;">#</span>
	
<span style="color:#ff0000;">/06 00 00 00 06 00 .+ 0[0-9] 00 00 00 00 00$/</span> {
	
    <span style="color:#808080;"># button code check</span>
    <span style="color:#339966;">switch</span> (<span style="color:#3366ff;">$65</span>) {
        <span style="color:#339966;">case</span> <span style="color:#ff00ff;">"00"</span>: <span style="color:#339966;">print</span> <span style="color:#ff00ff;">"click released"</span>;     <span style="color:#339966;">break</span>;
        <span style="color:#339966;">case</span> <span style="color:#ff00ff;">"01"</span>: <span style="color:#339966;">print</span> <span style="color:#ff00ff;">"left click"</span>;         <span style="color:#339966;">break</span>;
        <span style="color:#339966;">case</span> <span style="color:#ff00ff;">"02"</span>: <span style="color:#339966;">print</span> <span style="color:#ff00ff;">"right click"</span>;        <span style="color:#339966;">break</span>;
        <span style="color:#339966;">case</span> <span style="color:#ff00ff;">"03"</span>: <span style="color:#339966;">print</span> <span style="color:#ff00ff;">"left+right click"</span>;   <span style="color:#339966;">break</span>;
        <span style="color:#339966;">case</span> <span style="color:#ff00ff;">"04"</span>: <span style="color:#339966;">print</span> <span style="color:#ff00ff;">"central click"</span>;      <span style="color:#339966;">break</span>;
        <span style="color:#339966;">default</span>:   <span style="color:#339966;">print</span> <span style="color:#ff00ff;">"code "</span> <span style="color:#3366ff;">$65</span> <span style="color:#ff00ff;">" click"</span>; <span style="color:#339966;">break</span>;
    }
	
}
      </pre>
      
      <p dir="ltr">Let's try it:</p>
      
      <pre>
$ sudo hexinject -s -i usbmon3 | awk -f mouse_click.awk
left click
click released
central click
click released
left+right click
click released
...
      </pre>

      <p>The script just compares the value of a byte of the USB packet, against a list of known values for mouse buttons.</p>

      <p>This experiment illustrates the <em>extreme versatility of the "Data Oriented" approach</em> used by hexinject. In the future I hope to deepen the USB protocol and maybe write a post that uses hexinject in USB injection mode (really cool IMHO).</p>
      
      <p>At the moment I haven't a very in-depth knowledge of USB, but if you want to know the meaning of the rest of the dump can refer to this document: <a href="http://www.usb.org/developers/devclass_docs/HID1_11.pdf">http://www.usb.org/developers/devclass_docs/HID1_11.pdf</a>, or this tutorial (shorter): <a href="http://www.faculty.iu-bremen.de/birk/lectures/PC101-2003/14usb/FINAL%20VERSION/usb_protocol.html">http://www.faculty.iu-bremen.de/birk/lectures/PC101-2003/14usb/FINAL%20VERSION/usb_protocol.html</a>.</p>
	
    </article>
  </body>
</html>
